<!--
 * @Date: 2025-03-03
 * @LastEditors: GoKo-Son626
 * @LastEditTime: 2025-03-04
 * @FilePath: /Day-Do/25-3-3.md
 * @Description: 
-->
### 3.1. linux->commit
**(06aac7187ecc8407dda5b67eeb109f84b43cf81a)**

**作用是在 RISC-V KVM（Kernel-based Virtual Machine）中为 Guest（虚拟机）增加对 Smnpm 和 Ssnpm 这两个扩展的支持。**

- Smnpm（Supervisor-mode **Non-maskable Pointer Masking（不可绕过指针屏蔽）**）-> **Hypervisor层(管理程序层)的指针掩码**
  - 这是一个**在 Supervisor 模式（S-mode）下提供指针屏蔽（Pointer Masking）功能的扩展**。
  - 这个扩展的目标是增强安全性，防止 S-mode 下的恶意代码泄露敏感指针信息。
  - 用于 Hypervisor 层（管理虚拟机的 OS），Hypervisor 需要开启它，Guest OS 才能用 Ssnpm。
  - 作用是给 Hypervisor 提供指针掩码，防止 Guest 越权访问 Host 资源。
  - 如果 Hypervisor 没有 Smnpm，那么 Guest 的 Ssnpm 也无法启用
- Ssnpm（Supervisor Sub-mode Non-maskable Pointer Masking）
  - **Ssnpm 是 Smnpm 的子集，用于 VS-mode（虚拟机的 S-mode）。**
  - 关键点：
    - henvcfg（Hypervisor Environment Configuration Register）是 RISC-V H 扩展（Hypervisor 扩展）中的一个寄存器，主要用于控制 Guest OS（虚拟机） 运行时的权限和行为。
    - henvcfg.PMM（Hypervisor 环境配置寄存器中的 Pointer Masking Mode 位）是 VS-mode 控制指针屏蔽的关键位。->  **用于控制 Guest OS 指针掩码机制**
    - Ssnpm 依赖于 henvcfg.PMM，而不是 Smnpm。
    - 用于 Guest 层（虚拟机里的 OS），控制 henvcfg.PMM 这个寄存器。
    - 作用是 限制 Guest OS 访问某些内存地址，防止信息泄露。
    - 只影响 Guest OS 自己的进程，不会影响 Hypervisor。
- **结论**
  - 主机（Host） 需要支持 Ssnpm，才能让 Guest（虚拟机）使用 Smnpm。
  - 当前 KVM 还没有实现 SBI（Supervisor Binary Interface）中的“Firmware Features”扩展，所以 Smnpm 目前对 Guest 无实际影响。
  - Ssnpm 需要通过 senvcfg CSR（Control Status Register，控制状态寄存器）配置，而 KVM 没有拦截该 CSR，因此 Guest 仍然可以看到 Ssnpm。

- **Hypervisor 层（虚拟机管理程序/**管理程序层）：
  - 直接运行在 物理硬件 上。（计算机硬件和虚拟机之间）
  - 负责管理 多个 Guest OS（虚拟机）。
  - 控制 CPU、内存、I/O 访问，分配资源给 Guest OS。
  - 相当于“宿主机”或者“虚拟化管理器”，比如 QEMU/KVM、VMware ESXi、Xen 等。
- **Guest 层（客户机层）：**
  - 运行在 虚拟机里，由 Hypervisor 提供 CPU、内存等资源。
  - 相当于“虚拟机里的操作系统”，比如运行 Linux、Windows、FreeBSD 等系统的虚拟机。

- **环境配置寄存器**
在 RISC-V 架构中，不同模式（用户态、监督态、Hypervisor 等）都有自己的环境配置寄存器，主要用于管理特定运行模式下的行为。

  - 主要的环境配置寄存器
  
| 寄存器  | 作用                         | 说明                                 |
| ------- | ---------------------------- | ------------------------------------ |
| senvcfg | Supervisor（S 模式）环境配置 | 监督模式 OS 用于管理进程             |
| henvcfg | Hypervisor（H 模式）环境配置 | Hypervisor 用于管理 Guest 虚拟机     |
| menvcfg | Machine（M 模式）环境配置    | 机器模式（最高权限）用于管理整个 CPU |

其中，henvcfg.PMM 主要用于 Hypervisor 管理 Guest 的指针掩码

- **SBI** 
  - SBI（Supervisor Binary Interface，监督二进制接口）是 RISC-V 的一个标准化接口，用于在 Supervisor OS（例如 Linux） 和 固件（例如 OpenSBI） 之间进行通信。
  - 提供 Hypervisor 或 固件 的一些低级功能，Guest OS 可以调用这些功能，而不直接访问硬件

- **SBI Firmware Features 扩展**
  - Firmware Features 扩展是 SBI 的一个功能，它提供了 查询和管理固件功能 的能力，比如：

  - 查看 Hypervisor 是否支持某个 RISC-V 扩展（如 Smnpm、Ssnpm）。
  - 获取系统可用的 CPU 资源信息。
  - 控制 CPU 进入低功耗模式。
  - 作用：
    - Hypervisor 通过 SBI 查询当前硬件支持哪些虚拟化扩展。
    - Guest OS 通过 SBI 了解宿主机的功能，并进行优化配置。
    - 例如：
      - Guest 想用 Smnpm，它可以通过 SBI_FIRMWARE_FEATURES 来检查宿主机是否支持。

- **KVM**
  - KVM（Kernel-based Virtual Machine）是 Linux 内核内置的 虚拟化解决方案，它能让 Linux 直接变成一个 Type-1 Hypervisor，用于管理虚拟机（Guest OS）。
  - KVM 作用
    - 提供虚拟 CPU（vCPU），让 Guest OS 以为自己运行在真实的硬件上。
    - 管理 Guest OS 的内存、I/O、设备映射。
    - 支持硬件加速（如 RISC-V H 扩展、Intel VT-x、AMD SVM）。

- **vcpu_onereg.c**
  - 文件的作用:vcpu_onereg.c 是 KVM 的一个 vCPU 相关代码文件，用于管理虚拟机的 CPU 寄存器。
  - “one reg” 机制：表示 虚拟 CPU（vCPU） 可以通过 KVM API 访问和修改 单个寄存器。
  - 主要用于：
    - 获取 vCPU 当前状态（例如 pc, sp, hartid）。
    - 修改 vCPU 的寄存器值。
    - 支持不同架构（如 x86, ARM, RISC-V）的虚拟 CPU 操作。



### 1. linux->commit
**()**

### 1. linux->commit
**()**

### 1. linux->commit
**()**

### 1. linux->commit
**()**

### 1. linux->commit
**()**

### 1. linux->commit
**()**

### 1. linux->commit
**()**

### 1. linux->commit
**()**

### 1. linux->commit
**()**

### 1. linux->commit
**()**

